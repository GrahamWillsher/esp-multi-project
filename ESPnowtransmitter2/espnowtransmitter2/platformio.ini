; PlatformIO Project Configuration File
;
; ESP-NOW Transmitter (Modular)
; Hardware: Olimex ESP32-POE2 (WROVER-E)
;
; Features:
;  - ESP-NOW transmitter protocol
;  - Ethernet connectivity (W5500)
;  - MQTT telemetry publishing
;  - HTTP OTA firmware updates
;  - NTP time synchronization

[platformio]
default_envs = olimex_esp32_poe2
build_dir = c:\piobuild3

[env:olimex_esp32_poe2]
platform = espressif32@6.5.0
board = esp32-poe2
framework = arduino
lib_ldf_mode = chain+

; --- Flash size: 4MB ---
board_upload.flash_size = 4MB


; Build scripts
extra_scripts = 
    pre:extra_scripts/add_fs_include.py
    post:../../esp32common/scripts/version_firmware.py

; Build flags
build_flags = 
    -std=gnu++17
    -I../../esp32common/espnow_transmitter
    -I../../esp32common
    -I$PROJECT_INCLUDE_DIR
    -I$PROJECT_SRC_DIR/battery_emulator
    -I${platformio.packages_dir}/framework-arduinoespressif32/libraries/FS/src
    
    ; Inverter Configuration: CAN-based only (no Modbus for Phase 1)
    -DSUPPORT_AFORE_CAN=1
    -DSUPPORT_BYD_CAN=1
    -DSUPPORT_FERROAMP_CAN=1
    -DSUPPORT_FOXESS_CAN=1
    -DSUPPORT_GROWATT_HV_CAN=1
    -DSUPPORT_GROWATT_LV_CAN=1
    -DSUPPORT_GROWATT_WIT_CAN=1
    -DSUPPORT_PYLON_CAN=1
    -DSUPPORT_PYLON_LV_CAN=1
    -DSUPPORT_SCHNEIDER_CAN=1
    -DSUPPORT_SMA_BYD_H_CAN=1
    -DSUPPORT_SMA_BYD_HVS_CAN=1
    -DSUPPORT_SMA_LV_CAN=1
    -DSUPPORT_SMA_TRIPOWER_CAN=1
    -DSUPPORT_SOFAR_CAN=1
    -DSUPPORT_SOL_ARK_LV_CAN=1
    -DSUPPORT_SOLAX_CAN=1
    -DSUPPORT_SOLXPOW_CAN=1
    -DSUPPORT_SUNGROW_CAN=1
    ; Modbus inverters disabled for Phase 1 (no eModbus dependency)
    -DSUPPORT_BYD_MODBUS=0
    -DSUPPORT_KOSTAL_RS485=0
    -DSUPPORT_GROWATT_MODBUS=0
    -DSUPPORT_FRONIUS_MODBUS=0
    -DSUPPORT_SOLARMAX_RS485=0
    -DSUPPORT_SMA_MODBUS=0
    -DSUPPORT_SOFAR_MODBUS=0
    -DSUPPORT_VICTRON_MODBUS=0
    -DSUPPORT_PHOCOS_CAN=0
    
    ; Device identification for firmware versioning
    -D TRANSMITTER_DEVICE
    -D DEVICE_HARDWARE=\"ESP32-POE2\"
    -D FW_VERSION_MAJOR=2
    -D FW_VERSION_MINOR=0
    -D FW_VERSION_PATCH=0
    ; Metadata embedding (human-readable format)
    -D PIO_ENV_NAME=$PIOENV
    -D TARGET_DEVICE=TRANSMITTER
    !python -c "import time; print('-D BUILD_DATE=\"' + time.strftime('%%d-%%m-%%Y %%H:%%M:%%S') + '\"')"

    ; Debug and hardware configuration
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DARDUINO_ARCH_ESP32
    -DHW_DEVKIT
    -Wno-deprecated-declarations
    -Wno-builtin-macro-redefined
    -Wno-cpp
    ; Logging control - set compile-time log level
    ; LOG_NONE=0, LOG_ERROR=1, LOG_WARN=2, LOG_INFO=3, LOG_DEBUG=4, LOG_TRACE=5
    -D COMPILE_LOG_LEVEL=LOG_INFO    ; Default: INFO and above (change to LOG_DEBUG for verbose)

; Library dependencies
lib_deps = 
    ; MQTT client for telemetry
    knolleary/PubSubClient @ ^2.8
    
    ; JSON serialization
    bblanchon/ArduinoJson @ ^6.21.3
    
    ; Async web server (for OTA)
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git
    
    ; Network utilities (ping for IP conflict detection & reachability testing)
    marian-craciunescu/ESP32Ping @ ^1.7
    
    ; CAN bus communication (MCP2515 via SPI)
    autowp/autowp-mcp2515 @ ^1.3.1

    ; Arduino ESP32 core Preferences library (NVS)
    ${platformio.packages_dir}/framework-arduinoespressif32/libraries/Preferences
    ; Arduino ESP32 core FS library (required by SD_MMC)
    ${platformio.packages_dir}/framework-arduinoespressif32/libraries/FS

; Ignore libraries that conflict
lib_ignore = 
    WebServer

; Extra library directories (for local libraries)
lib_extra_dirs = 
    ../../esp32common

; Upload settings
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Partition scheme (ensure space for OTA)
board_build.partitions = partitions_4mb_ota.csv

; Flash settings
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; PSRAM settings (WROVER variant)
board_build.arduino.memory_type = qio_qspi

; Optimization
build_type = release
