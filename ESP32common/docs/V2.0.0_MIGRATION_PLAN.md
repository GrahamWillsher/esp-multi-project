# Version 2.0.0 Migration Plan

## Overview
This document outlines the migration work required for v2.0.0 development, building on the metadata implementation completed in v1.1.1.

---

## v1.1.1 Baseline - What We Have

### ✅ Completed Features
1. **Firmware Metadata System**
   - 128-byte metadata structure embedded in .rodata section
   - Magic markers (0x464D5441 "FMTA", 0x454E4446 "ENDF") for binary search
   - Build flags: PIO_ENV_NAME, TARGET_DEVICE, BUILD_DATE (DD-MM-YYYY HH:MM:SS)
   - C++ library in `esp32common/firmware_metadata/`

2. **ESP-NOW Metadata Exchange**
   - Message types: `msg_metadata_request` (0x14), `msg_metadata_response` (0x15)
   - Request sent automatically on transmitter connection
   - Response includes: env_name, device_type, version (major/minor/patch), build_date, valid flag

3. **TransmitterManager Metadata Storage**
   - Explicit `metadata_received` flag (fixes detection logic)
   - Storage for all metadata fields
   - Accessor methods: `hasMetadata()`, `isMetadataValid()`, `getMetadataVersion()`, etc.

4. **API Endpoints**
   - `/api/firmware_info` - Returns current device firmware metadata
   - `/api/transmitter_metadata` - Returns transmitter metadata received via ESP-NOW
   - Status indicators: "received" or "waiting"

5. **OTA Page Enhancements**
   - JavaScript binary metadata extraction from .bin files
   - Visual indicators:
     - Green ● - Valid metadata from .rodata
     - Yellow * - Fallback to build flags (metadata not valid)
     - Gray ○ - Waiting for metadata
   - Displays firmware info before upload
   - Metadata shown for both receiver and transmitter firmware

6. **Build Integration**
   - Post-build script creates versioned firmware: `env_fw_2_0_0.bin`
   - Metadata extraction tool: `extract_firmware_metadata.py`
   - Both projects (receiver & transmitter) embed metadata

---

## v2.0.0 Objectives - What's Missing

### 1. **Compatibility Validation** ⏳ NOT IMPLEMENTED
**Current State**: Metadata is displayed but NOT validated
**What's Missing**:
- No minimum compatible version checking
- No protocol version validation
- No environment/device type matching
- User can upload incompatible firmware

**Required Work**:
```javascript
// OTA page JavaScript enhancement needed
function validateCompatibility(receiverMeta, transmitterMeta) {
    // Check minimum compatible version
    // Check protocol version match
    // Check environment compatibility
    // Return: { compatible: bool, reason: string }
}
```

**Files to Modify**:
- `espnowreciever_2/lib/webserver/pages/ota_page.cpp` (JavaScript)
- `esp32common/espnow_transmitter/espnow_common.h` (add protocol version constants)
- `esp32common/firmware_metadata/firmware_metadata.h` (add min_compatible_version field)

---

### 2. **Version Compatibility Check API** ⏳ NOT IMPLEMENTED
**What's Needed**:
- `/api/check_compatibility` endpoint
- Takes firmware version as parameter
- Returns compatibility status and detailed reason
- Used before upload to warn user

**Implementation**:
```cpp
// In api_handlers.cpp
static esp_err_t api_check_compatibility_handler(httpd_req_t *req) {
    // Parse version parameter
    // Compare with current receiver version
    // Check MIN_COMPATIBLE_VERSION constant
    // Return JSON: { compatible: true/false, reason: "..." }
}
```

**Files to Create/Modify**:
- `espnowreciever_2/lib/webserver/api/api_handlers.cpp`

---

### 3. **Metadata Structure Enhancement** ⏳ INCOMPLETE
**Current Structure** (128 bytes):
```cpp
struct Metadata {
    uint32_t magic_start;        // 4 bytes
    char env_name[32];           // 32 bytes
    char device_type[16];        // 16 bytes
    uint8_t version_major;       // 1 byte
    uint8_t version_minor;       // 1 byte
    uint8_t version_patch;       // 1 byte
    uint8_t reserved1;           // 1 byte
    char build_date[48];         // 48 bytes
    uint8_t reserved[20];        // 20 bytes
    uint32_t magic_end;          // 4 bytes
};  // Total: 128 bytes
```

**Missing Fields** (use reserved space):
- `uint32_t min_compatible_version` (4 bytes) - Minimum compatible firmware version
- `uint8_t protocol_version` (1 byte) - ESP-NOW protocol version
- `uint8_t hw_variant` (1 byte) - Hardware variant identifier
- `uint16_t build_number` (2 bytes) - CI/CD build number
- `char git_hash[12]` (12 bytes) - Git commit hash (short)

**Remaining reserved**: 0 bytes (perfect fit!)

**Files to Modify**:
- `esp32common/firmware_metadata/firmware_metadata.h`
- `esp32common/firmware_metadata/firmware_metadata.cpp`
- Both `platformio.ini` files (add build flags)

---

### 4. **Upload Blocking/Warning System** ⏳ NOT IMPLEMENTED
**What's Needed**:
- Pre-upload compatibility check
- Modal dialog warning user of incompatibility
- Option to proceed anyway (with confirmation)
- Block upload if critically incompatible (optional)

**Implementation**:
```javascript
// Before upload starts
async function checkAndWarnBeforeUpload(file, device) {
    const metadata = await extractMetadataFromFile(file);
    const compatibility = await fetch('/api/check_compatibility?version=' + metadata.version);
    
    if (!compatibility.compatible) {
        // Show modal warning
        const proceed = confirm(`Warning: ${compatibility.reason}\n\nProceed anyway?`);
        if (!proceed) return false;
    }
    
    return true;
}
```

**Files to Modify**:
- `espnowreciever_2/lib/webserver/pages/ota_page.cpp`

---

### 5. **Version History/Rollback** ⏳ NOT IMPLEMENTED
**What's Needed**:
- Store last N firmware versions in LittleFS
- Display version history on OTA page
- One-click rollback to previous version
- Automatic rollback on boot failure (optional)

**Storage Structure**:
```
/firmware_history/
  ├── receiver_1_1_1.bin
  ├── receiver_1_1_0.bin
  ├── transmitter_1_1_1.bin
  └── transmitter_1_1_0.bin
```

**API Endpoints Needed**:
- `/api/firmware_history` - List available versions
- `/api/rollback?version=1.1.0&device=receiver` - Trigger rollback

**Files to Create**:
- `espnowreciever_2/lib/webserver/api/firmware_history.cpp`
- `espnowreciever_2/lib/webserver/pages/firmware_history_page.cpp`

---

### 6. **CI/CD Integration** ⏳ NOT IMPLEMENTED
**What's Needed**:
- GitHub Actions workflow for automated builds
- Automatic version bumping on release
- Build artifacts with metadata embedded
- Automated metadata extraction and validation

**Workflow File**: `.github/workflows/build.yml`
```yaml
name: Build Firmware
on: [push, release]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PlatformIO
      - name: Build Receiver
      - name: Build Transmitter
      - name: Extract Metadata
      - name: Upload Artifacts
```

**Files to Create**:
- `.github/workflows/build.yml`
- `.github/workflows/release.yml`

---

### 7. **Documentation Gaps** ⏳ INCOMPLETE
**Missing Documentation**:
- Metadata structure specification (complete reference)
- ESP-NOW message protocol v2.0 spec
- OTA upload procedure (user guide)
- Compatibility matrix (which versions work together)
- Rollback procedure
- Troubleshooting guide (metadata issues)

**Files to Create**:
- `docs/METADATA_SPECIFICATION.md`
- `docs/ESPNOW_PROTOCOL_V2.md`
- `docs/OTA_USER_GUIDE.md`
- `docs/COMPATIBILITY_MATRIX.md`
- `docs/TROUBLESHOOTING_METADATA.md`

---

## Implementation Phases

### Phase 1: Enhanced Metadata Structure (Week 1)
**Priority**: HIGH  
**Effort**: 2-3 days

1. **Update metadata structure** with new fields
   - Add min_compatible_version
   - Add protocol_version
   - Add hw_variant
   - Add build_number
   - Add git_hash

2. **Update build flags** in platformio.ini
   ```ini
   -D MIN_COMPATIBLE_VERSION=20000
   -D PROTOCOL_VERSION=2
   -D HW_VARIANT=1
   !python -c "import subprocess; print('-D GIT_HASH=\"' + subprocess.check_output(['git', 'rev-parse', '--short', 'HEAD']).decode().strip() + '\"')"
   ```

3. **Update ESP-NOW response** to include new fields

4. **Update JavaScript extraction** to parse new fields

**Testing**:
- Build firmware and verify metadata with `extract_firmware_metadata.py`
- Upload and verify display on OTA page
- Verify ESP-NOW exchange includes new fields

**Deliverable**: Enhanced metadata with all fields populated

---

### Phase 2: Compatibility Validation (Week 2)
**Priority**: HIGH  
**Effort**: 3-4 days

1. **Implement compatibility check logic**
   - Version comparison algorithm
   - Protocol version matching
   - Environment validation

2. **Create `/api/check_compatibility` endpoint**

3. **Add JavaScript validation** in OTA page
   - Pre-upload check
   - Warning modal
   - Compatibility badge display

4. **Update OTA page UI**
   - Color-coded compatibility status
   - Detailed reason display
   - "Force Upload" option with confirmation

**Testing**:
- Try uploading v1.1.1 to v2.0.0 system (should warn)
- Try uploading receiver firmware to transmitter (should block)
- Verify warnings display correctly
- Test force upload override

**Deliverable**: Working compatibility validation system

---

### Phase 3: Version History & Rollback (Week 3)
**Priority**: MEDIUM  
**Effort**: 4-5 days

1. **Implement firmware history storage**
   - LittleFS directory structure
   - Automatic archiving on successful upload
   - Storage limit (e.g., last 3 versions)

2. **Create firmware history API**
   - List available versions
   - Trigger rollback
   - Delete old versions

3. **Build firmware history UI page**
   - Table of available versions
   - One-click rollback buttons
   - Delete old versions option

4. **Implement rollback mechanism**
   - Copy archived firmware to active location
   - Trigger device restart
   - Verify boot with rolled-back version

**Testing**:
- Upload multiple firmware versions
- Verify history is stored correctly
- Test rollback to previous version
- Verify automatic cleanup of old versions

**Deliverable**: Complete version history and rollback system

---

### Phase 4: CI/CD Integration (Week 4)
**Priority**: LOW  
**Effort**: 2-3 days

1. **Create GitHub Actions workflows**
   - Build on push
   - Build on release creation
   - Automatic versioning

2. **Implement automated metadata extraction**
   - Extract from built .bin files
   - Include in release notes
   - Upload as release artifacts

3. **Version bumping automation**
   - Parse current version from platformio.ini
   - Increment based on commit message
   - Update files and commit

**Testing**:
- Trigger workflow with test commit
- Verify build artifacts are created
- Check metadata extraction output
- Test release creation flow

**Deliverable**: Automated build and release pipeline

---

### Phase 5: Documentation (Week 5)
**Priority**: MEDIUM  
**Effort**: 2-3 days

1. **Write metadata specification**
2. **Document ESP-NOW protocol v2**
3. **Create OTA user guide**
4. **Build compatibility matrix**
5. **Write troubleshooting guide**

**Deliverable**: Complete documentation suite

---

## Risk Assessment

### High Risk Items
1. **Metadata structure changes breaking compatibility**
   - Mitigation: Keep magic markers and offsets consistent
   - Fallback: Old firmware can still be parsed (graceful degradation)

2. **LittleFS storage limits for version history**
   - Mitigation: Implement storage limit and auto-cleanup
   - Fallback: Disable history if storage < threshold

3. **Compatibility validation too strict**
   - Mitigation: Always allow "force upload" option
   - Fallback: Disable validation in emergency mode

### Medium Risk Items
1. **CI/CD workflow complexity**
   - Mitigation: Start simple, iterate
   - Fallback: Manual builds remain available

2. **Rollback mechanism failure**
   - Mitigation: Extensive testing before deployment
   - Fallback: Manual re-upload of known good firmware

### Low Risk Items
1. **Documentation incomplete**
   - Mitigation: Iterative documentation as features are built
   - Fallback: Code comments and inline help

---

## Success Criteria

### Phase 1 Success
- [ ] Metadata structure expanded to 128 bytes with all new fields
- [ ] Build flags populate all metadata fields correctly
- [ ] JavaScript extracts and displays all new fields
- [ ] ESP-NOW exchange includes complete metadata

### Phase 2 Success
- [ ] Compatibility check API working
- [ ] OTA page displays compatibility status
- [ ] Upload blocked/warned for incompatible firmware
- [ ] Force upload option available with confirmation

### Phase 3 Success
- [ ] Firmware history stored in LittleFS
- [ ] History UI displays available versions
- [ ] Rollback successfully restores previous version
- [ ] Automatic cleanup keeps storage under control

### Phase 4 Success
- [ ] GitHub Actions workflow builds firmware automatically
- [ ] Metadata extracted and included in releases
- [ ] Version bumping works correctly
- [ ] Build artifacts downloadable from releases

### Phase 5 Success
- [ ] All documentation complete and accurate
- [ ] Users can understand metadata system without asking
- [ ] Troubleshooting guide covers common issues
- [ ] Compatibility matrix clear and up-to-date

---

## Out of Scope for v2.0.0

The following items are deferred to future versions:

1. **Over-The-Air Updates via ESP-NOW** (v2.1.0)
   - Currently requires HTTP upload to receiver
   - Future: Direct OTA via ESP-NOW packets

2. **Automatic Update Checking** (v2.1.0)
   - Check for updates on GitHub
   - Notify user of available updates

3. **Delta Updates** (v2.2.0)
   - Only send changed portions of firmware
   - Reduces upload time and bandwidth

4. **Signed Firmware** (v2.3.0)
   - Cryptographic signatures
   - Prevents unauthorized firmware uploads

5. **Multi-Device Management** (v3.0.0)
   - Manage multiple transmitter/receiver pairs
   - Centralized update deployment

---

## Timeline Estimate

| Phase | Duration | Dependencies | Start Date | End Date |
|-------|----------|--------------|------------|----------|
| Phase 1 | 3 days | None | Week 1 Mon | Week 1 Wed |
| Phase 2 | 4 days | Phase 1 | Week 1 Thu | Week 2 Tue |
| Phase 3 | 5 days | Phase 2 | Week 2 Wed | Week 3 Tue |
| Phase 4 | 3 days | Phase 1-3 | Week 3 Wed | Week 4 Fri |
| Phase 5 | 3 days | Phase 1-4 | Week 4 Mon | Week 4 Wed |

**Total Estimated Duration**: 18 working days (~4 weeks)

---

## Notes

- All work builds on stable v1.1.1 baseline
- Each phase is independently testable
- Credentials remain placeholders in Git (restored locally as needed)
- Version numbers follow semantic versioning: MAJOR.MINOR.PATCH
- Breaking changes increment MAJOR version
- New features increment MINOR version
- Bug fixes increment PATCH version

---

## Questions for Discussion

1. **Compatibility enforcement**: Should incompatible uploads be completely blocked, or just warned?
2. **Storage limits**: How many firmware versions should be kept in history? (Recommend 3)
3. **Rollback triggers**: Should rollback be automatic on boot failure, or manual only?
4. **CI/CD priority**: Is automated building essential for v2.0.0, or can it wait?
5. **Protocol versioning**: Should protocol version 2 be backward compatible with protocol version 1?

---

**Document Version**: 1.0  
**Created**: February 5, 2026  
**Last Updated**: February 5, 2026  
**Author**: AI Assistant  
**Status**: Draft for Review
