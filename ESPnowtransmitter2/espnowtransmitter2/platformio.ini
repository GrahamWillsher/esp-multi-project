; PlatformIO Project Configuration File
;
; ESP-NOW Transmitter (Modular)
; Hardware: Olimex ESP32-POE2 (WROVER-E)
;
; Features:
;  - ESP-NOW transmitter protocol
;  - Ethernet connectivity (W5500)
;  - MQTT telemetry publishing
;  - HTTP OTA firmware updates
;  - NTP time synchronization

[platformio]
default_envs = olimex_esp32_poe2
build_dir = c:\piobuild3

[env:olimex_esp32_poe2]
platform = espressif32@6.5.0
board = esp32-poe2
framework = arduino
lib_ldf_mode = chain+

; --- Flash size: 4MB ---
board_upload.flash_size = 4MB


; Build scripts
extra_scripts = 
    pre:extra_scripts/add_fs_include.py
    pre:../../esp32common/scripts/version_firmware.py

; Build flags
build_flags = 
    -std=gnu++17
    -I../../esp32common/espnow_transmitter
    -I../../esp32common
    -I$PROJECT_INCLUDE_DIR
    -I$PROJECT_SRC_DIR/battery_emulator
    -I${platformio.packages_dir}/framework-arduinoespressif32/libraries/FS/src
    
    ; Inverter configuration is defined in include/inverter_config.h
    ; This provides a single source of truth for which inverters are supported
    
    ; CAN bus support (required for Battery Emulator integration)
    -D CONFIG_CAN_ENABLED
    
    ; Device identification for firmware versioning
    -D TRANSMITTER_DEVICE
    ; DEVICE_HARDWARE, PIO_ENV_NAME, and BUILD_DATE are generated dynamically by version_firmware.py
    -D FW_VERSION_MAJOR=2
    -D FW_VERSION_MINOR=0
    -D FW_VERSION_PATCH=0
    -D TARGET_DEVICE=TRANSMITTER

    ; Debug and hardware configuration
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DARDUINO_ARCH_ESP32
    -DHW_DEVKIT
    -Wno-deprecated-declarations
    -Wno-builtin-macro-redefined
    -Wno-cpp
    ; Logging control - set compile-time log level
    ; LOG_NONE=0, LOG_ERROR=1, LOG_WARN=2, LOG_INFO=3, LOG_DEBUG=4, LOG_TRACE=5
    -D COMPILE_LOG_LEVEL=LOG_INFO    ; Default: INFO and above (change to LOG_DEBUG for verbose)

; Library dependencies
lib_deps = 
    ; MQTT client for telemetry
    knolleary/PubSubClient @ ^2.8
    
    ; JSON serialization
    bblanchon/ArduinoJson @ ^6.21.3
    
    ; Network utilities (ping for IP conflict detection & reachability testing)
    marian-craciunescu/ESP32Ping @ ^1.7
    
    ; CAN bus communication (MCP2515 via SPI)
    autowp/autowp-mcp2515 @ ^1.3.1

    ; Arduino ESP32 core Preferences library (NVS)
    ${platformio.packages_dir}/framework-arduinoespressif32/libraries/Preferences
    ; Arduino ESP32 core FS library (required by SD_MMC)
    ${platformio.packages_dir}/framework-arduinoespressif32/libraries/FS

; Ignore libraries that conflict
lib_ignore = 
    WebServer

; Build exclusions (Modbus inverter files not needed - all disabled in inverter_config.h)
build_src_filter = 
    +<*>
    -<battery_emulator/inverter/BYD-MODBUS.cpp>
    -<battery_emulator/inverter/KOSTAL-RS485.cpp>
    -<battery_emulator/inverter/ModbusInverterProtocol.cpp>

; Extra library directories (for local libraries)
lib_extra_dirs = 
    ../../esp32common

; Upload settings
upload_speed = 921600
monitor_speed = 115200
monitor_filters = esp32_exception_decoder

; Partition scheme (ensure space for OTA)
board_build.partitions = partitions_4mb_ota.csv

; Flash settings
board_build.flash_mode = qio
board_build.f_flash = 80000000L
board_build.f_cpu = 240000000L

; PSRAM settings (WROVER variant)
board_build.arduino.memory_type = qio_qspi

; Optimization
build_type = release
